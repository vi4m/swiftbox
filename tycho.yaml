---
name: swift_vapor_example
group: pl.allegro.tech.appengine
version_scheme:
    type: external
    commands:
      - ['bash', '-c', './src/get_version.sh 2> /dev/null || cat APP_VERSION']

build:
  - command: "./build_bamboo_ci.sh"

package: "artifact/swift_vapor_example.zip"

publish:
    - artifactory:
        host: artifactory.allegrogroup.com

vars:
    health_check: &HEALTH_CHECK
        protocol: "HTTP"
        path: "/status/ping"
        gracePeriodSeconds: 30
        intervalSeconds: 5
        portIndex: 0
        timeoutSeconds: 10
        maxConsecutiveFailures: 2
    timeouts: &TIMEOUTS
        get_instances_urls_timeout: 120
        check_instances_health_timeout: 120

deploy:
    dev:
        - marathon:
            destination: dev
            command: "cd ./opt/swift_vapor_example/dist/ && ./launch_docker_container.sh development"
            instances: 1
            cpus: 0.3
            mem: 128
            health_check:
                << : *HEALTH_CHECK
            timeouts:
                << : *TIMEOUTS
            env_vars:
                PROJECT_PATH: ./
                PROJECT_PROPERTIES_PATH: ./project-properties.json
            labels:
                consul: "swift_vapor_example"

